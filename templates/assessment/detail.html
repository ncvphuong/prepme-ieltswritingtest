{% extends 'base.html' %}
{% load static %}

{% block title %}Assessment Results - IELTS Writing Test{% endblock %}

{% block content %}
<div class="container py-4">
    {% if assessment %}
        <!-- Assessment Results -->
        <div class="row">
            <div class="col-12">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Assessment Results</h2>
                    <div class="text-end">
                        <span class="badge bg-success fs-6">Assessment Complete</span>
                        <br>
                        <small class="text-muted">{{ assessment.completed_at|date:"M d, Y H:i" }}</small>
                    </div>
                </div>

                <!-- Overall Score Card -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body text-center bg-primary text-white">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <div class="h1 mb-0">{{ assessment.overall_band_score }}</div>
                                <p class="mb-0">Overall Band Score</p>
                            </div>
                            <div class="col-md-4">
                                <div class="h4 mb-1">{{ score_insights.band_description }}</div>
                                <small>IELTS Level</small>
                            </div>
                            <div class="col-md-4">
                                <div class="h5 mb-1">{{ assessment.processing_time_seconds }}s</div>
                                <small>Processing Time</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Task Information -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Task Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Task:</strong> {{ submission.task.title }}</p>
                                <p><strong>Code:</strong> {{ submission.task.task_code }}</p>
                                <p><strong>Module:</strong> {{ submission.task.get_module_type_display }}</p>
                                <p><strong>Type:</strong> {{ submission.task.get_task_number_display }}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Word Count:</strong> {{ submission.word_count }} words</p>
                                <p><strong>Word Limit:</strong> {{ submission.task.word_limit_min }}-{{ submission.task.word_limit_max }} words</p>
                                <p><strong>Submitted:</strong> {{ submission.submitted_at|date:"M d, Y H:i" }}</p>
                                <p><strong>AI Model:</strong> {{ assessment.ai_model_used }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Scores -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Detailed Score Breakdown</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-semibold">
                                        {% if submission.task.task_number == 1 %}Task Achievement{% else %}Task Response{% endif %}
                                    </span>
                                    <span class="h5 mb-0 text-primary">{{ assessment.task_achievement_score }}</span>
                                </div>
                                <div class="progress" style="height: 10px;">
                                    <div class="progress-bar bg-primary" style="width: {{ assessment.task_achievement_score|floatformat:1|mul:11.11 }}%"></div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-semibold">Coherence & Cohesion</span>
                                    <span class="h5 mb-0 text-success">{{ assessment.coherence_cohesion_score }}</span>
                                </div>
                                <div class="progress" style="height: 10px;">
                                    <div class="progress-bar bg-success" style="width: {{ assessment.coherence_cohesion_score|floatformat:1|mul:11.11 }}%"></div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-semibold">Lexical Resource</span>
                                    <span class="h5 mb-0 text-warning">{{ assessment.lexical_resource_score }}</span>
                                </div>
                                <div class="progress" style="height: 10px;">
                                    <div class="progress-bar bg-warning" style="width: {{ assessment.lexical_resource_score|floatformat:1|mul:11.11 }}%"></div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-semibold">Grammar & Accuracy</span>
                                    <span class="h5 mb-0 text-info">{{ assessment.grammar_accuracy_score }}</span>
                                </div>
                                <div class="progress" style="height: 10px;">
                                    <div class="progress-bar bg-info" style="width: {{ assessment.grammar_accuracy_score|floatformat:1|mul:11.11 }}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Strengths and Weaknesses -->
                {% if score_insights.strengths or score_insights.weaknesses %}
                    <div class="row mb-4">
                        {% if score_insights.strengths %}
                            <div class="col-md-6">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0"><i class="fas fa-check-circle"></i> Strengths</h6>
                                    </div>
                                    <div class="card-body">
                                        {% for strength in score_insights.strengths %}
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span>{{ strength.criterion }}</span>
                                                <span class="badge bg-success">{{ strength.score }}</span>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                        
                        {% if score_insights.weaknesses %}
                            <div class="col-md-6">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-header bg-warning text-white">
                                        <h6 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Areas for Improvement</h6>
                                    </div>
                                    <div class="card-body">
                                        {% for weakness in score_insights.weaknesses %}
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span>{{ weakness.criterion }}</span>
                                                <span class="badge bg-warning">{{ weakness.score }}</span>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                {% endif %}

                <!-- Detailed Feedback -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Detailed Feedback</h5>
                    </div>
                    <div class="card-body">
                        {% for feedback_type, feedback_list in feedback_by_type.items %}
                            {% for feedback in feedback_list %}
                                <div class="mb-4">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="text-primary mb-0">
                                            {% if feedback.feedback_type == 'task_achievement' %}
                                                {% if submission.task.task_number == 1 %}Task Achievement{% else %}Task Response{% endif %}
                                            {% elif feedback.feedback_type == 'coherence_cohesion' %}
                                                Coherence and Cohesion
                                            {% elif feedback.feedback_type == 'lexical_resource' %}
                                                Lexical Resource
                                            {% elif feedback.feedback_type == 'grammar_accuracy' %}
                                                Grammatical Range and Accuracy
                                            {% else %}
                                                {{ feedback.title }}
                                            {% endif %}
                                        </h6>
                                        <span class="badge bg-{{ feedback.severity }}">
                                            {{ feedback.get_severity_display }}
                                        </span>
                                    </div>
                                    
                                    <div class="p-3 border-start border-4 border-{{ feedback.severity }} bg-light">
                                        {{ feedback.content|linebreaks }}
                                        
                                        {% if feedback.suggestion %}
                                            <div class="mt-3 p-2 bg-info bg-opacity-10 rounded border-start border-3 border-info">
                                                <strong>Suggestion:</strong><br>
                                                {{ feedback.suggestion|linebreaks }}
                                            </div>
                                        {% endif %}
                                        
                                        {% if feedback.highlighted_text %}
                                            <div class="mt-2">
                                                <small class="text-muted">
                                                    <strong>Refers to:</strong> "{{ feedback.highlighted_text }}"
                                                </small>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        {% endfor %}
                    </div>
                </div>

                <!-- Your Response -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Your Response</h5>
                    </div>
                    <div class="card-body">
                        <div class="p-3 bg-white border rounded response-text">
                            {{ submission.content|linebreaks }}
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="d-flex justify-content-between">
                    <a href="{% url 'practice:history' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to History
                    </a>
                    <div>
                        <a href="{% url 'practice:task_detail' submission.task.pk %}" class="btn btn-outline-primary">
                            <i class="fas fa-redo"></i> Try Again
                        </a>
                        <a href="{% url 'assessment:history' %}" class="btn btn-primary">
                            <i class="fas fa-chart-line"></i> All Assessments
                        </a>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <!-- No Assessment Yet -->
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-clock fa-4x text-warning mb-4"></i>
                        <h4>Assessment in Progress</h4>
                        <p class="text-muted mb-4">
                            Your submission is being assessed by our AI system. 
                            This usually takes a few minutes.
                        </p>
                        
                        <div class="mb-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        
                        <p class="small text-muted">
                            Submitted: {{ submission.submitted_at|date:"M d, Y H:i" }}<br>
                            Task: {{ submission.task.title }} ({{ submission.task.task_code }})
                        </p>
                        
                        <div class="mt-4">
                            <button id="refresh-status" class="btn btn-primary">
                                <i class="fas fa-sync-alt"></i> Check Status
                            </button>
                            <a href="{% url 'practice:history' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left"></i> Back to History
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<style>
.response-text {
    font-family: 'Times New Roman', serif;
    font-size: 16px;
    line-height: 1.8;
    white-space: pre-wrap;
}

.border-info { border-color: #0dcaf0 !important; }
.border-suggestion { border-color: #198754 !important; }
.border-warning { border-color: #ffc107 !important; }
.border-error { border-color: #dc3545 !important; }

.bg-info { background-color: #0dcaf0 !important; }
.bg-suggestion { background-color: #198754 !important; }
.bg-warning { background-color: #ffc107 !important; }
.bg-error { background-color: #dc3545 !important; }

.progress-bar {
    transition: width 0.6s ease;
}
</style>

{% if not assessment %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const refreshButton = document.getElementById('refresh-status');
    let checkInterval;
    
    function checkAssessmentStatus() {
        fetch('{% url "assessment:status" submission.id %}')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'completed') {
                    clearInterval(checkInterval);
                    window.location.reload();
                } else if (data.status === 'failed') {
                    clearInterval(checkInterval);
                    alert('Assessment failed. Please try requesting assessment again.');
                }
            })
            .catch(error => {
                console.error('Error checking status:', error);
            });
    }
    
    // Auto-refresh every 30 seconds
    checkInterval = setInterval(checkAssessmentStatus, 30000);
    
    // Manual refresh button
    refreshButton.addEventListener('click', function() {
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
        checkAssessmentStatus();
        
        setTimeout(() => {
            this.innerHTML = '<i class="fas fa-sync-alt"></i> Check Status';
        }, 2000);
    });
    
    // Stop checking when user leaves page
    window.addEventListener('beforeunload', function() {
        clearInterval(checkInterval);
    });
});
</script>
{% endif %}
{% endblock %}